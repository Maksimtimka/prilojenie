<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test - –°–µ–º–µ–π–Ω—ã–µ –ó–∞–¥–∞–Ω–∏—è</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary: #c41e3a;
            --secondary: #2f5233;
            --bg: #f8f9fa;
            --text: #2d3436;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            background-color: #e5e5e5;
            display: flex;
            justify-content: center;
        }

        #app {
            width: 100%;
            max-width: 480px;
            background: white;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        .screen { display: none; text-align: center; }
        .screen.active { display: block; animation: fadeIn 0.4s ease-out; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        h1 { color: var(--primary); margin-bottom: 30px; }
        h2 { color: var(--secondary); }

        button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin: 10px 5px;
            width: 100%;
            transition: 0.2s;
        }

        button.alt { background: var(--secondary); }
        button.small { width: auto; padding: 8px 15px; font-size: 14px; }
        button:active { transform: scale(0.98); opacity: 0.9; }

        .balance-card {
            background: linear-gradient(135deg, var(--secondary), #1a331d);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            text-align: left;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .balance-amount { font-size: 28px; font-weight: bold; }

        .task-card {
            background: #fff;
            border: 1px solid #eee;
            border-left: 6px solid var(--primary);
            padding: 15px;
            margin: 15px 0;
            border-radius: 10px;
            text-align: left;
            position: relative;
        }

        .status-badge {
            font-size: 11px;
            text-transform: uppercase;
            padding: 3px 8px;
            border-radius: 5px;
            background: #eee;
            font-weight: bold;
        }

        select, input {
            width: 100%;
            padding: 14px;
            margin: 10px 0;
            border: 2px solid #eee;
            border-radius: 10px;
            font-size: 16px;
            outline: none;
        }

        select:focus, input:focus { border-color: var(--secondary); }

        .hidden { display: none; }
    </style>
</head>
<body>

<div id="app">
    <div id="welcome-screen" class="screen active">
        <div style="font-size: 80px;">üéÑ</div>
        <h1>–° –ù–æ–≤—ã–º –ì–æ–¥–æ–º!</h1>
        <p>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —Å–µ–º–µ–π–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –∑–∞–¥–∞—á.</p>
        <button onclick="showScreen('reg-screen')">–î–∞–ª–µ–µ</button>
    </div>

    <div id="reg-screen" class="screen">
        <h2>–ö—Ç–æ –∑–∞—à–µ–ª –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ?</h2>
        <button onclick="setUser('–ú–∞–∫—Å–∏–º')">üôã‚Äç‚ôÇÔ∏è –ú–∞–∫—Å–∏–º</button>
        <button onclick="setUser('–î–∏–∞–Ω–∞')">üôã‚Äç‚ôÄÔ∏è –î–∏–∞–Ω–∞</button>
        <button onclick="setUser('–ú–∞–º–∞')">üë©‚Äçüëß‚Äçüë¶ –ú–∞–º–∞</button>
    </div>

    <div id="main-screen" class="screen">
        <div class="balance-card">
            <div style="opacity: 0.8;">–ü—Ä–∏–≤–µ—Ç, <span id="current-user-name"></span>!</div>
            <div style="margin-top: 10px;">–í–∞—à –±–∞–ª–∞–Ω—Å:</div>
            <div class="balance-amount"><span id="user-balance">0.00</span> $</div>
        </div>
        
        <button onclick="showScreen('create-task-screen')">‚ûï –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ</button>
        <button class="alt" onclick="withdrawMoney()">üí∏ –í—ã–≤–æ–¥ –¥–µ–Ω–µ–≥</button>
        
        <h3 style="text-align: left; margin-top: 30px;">üìã –°–ø–∏—Å–æ–∫ –∑–∞–¥–∞–Ω–∏–π:</h3>
        <div id="tasks-list">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>

    <div id="create-task-screen" class="screen">
        <h2>–ù–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ</h2>
        
        <select id="task-type" onchange="toggleInput('task-type', 'custom-task', '–î—Ä—É–≥–æ–µ')">
            <option value="–ü—Ä–æ–ø—ã–ª–µ—Å–æ—Å–∏—Ç—å">üßπ –ü—Ä–æ–ø—ã–ª–µ—Å–æ—Å–∏—Ç—å</option>
            <option value="–ü–æ–º—ã—Ç—å –ø–æ—Å—É–¥—É">üçΩÔ∏è –ü–æ–º—ã—Ç—å –ø–æ—Å—É–¥—É</option>
            <option value="–ü–æ–º—ã—Ç—å –ø–æ–ª">üßº –ü–æ–º—ã—Ç—å –ø–æ–ª</option>
            <option value="–ü–æ–ª–∏—Ç—å —Ü–≤–µ—Ç—ã">üåª –ü–æ–ª–∏—Ç—å —Ü–≤–µ—Ç—ã</option>
            <option value="–ü–æ–∫–æ—Ä–º–∏—Ç—å –∫–æ—Ç–∞">üêà –ü–æ–∫–æ—Ä–º–∏—Ç—å –∫–æ—Ç–∞</option>
            <option value="–£–±—Ä–∞—Ç—å—Å—è –≤ –∫–æ–º–Ω–∞—Ç–µ">üßπ –£–±—Ä–∞—Ç—å—Å—è –≤ –∫–æ–º–Ω–∞—Ç–µ</option>
            <option value="–î—Ä—É–≥–æ–µ">‚ú® –î—Ä—É–≥–æ–µ...</option>
        </select>
        <input type="text" id="custom-task" class="hidden" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è">

        <p>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å:</p>
        <select id="task-for">
            <option value="–ú–∞–∫—Å–∏–º">–ú–∞–∫—Å–∏–º</option>
            <option value="–î–∏–∞–Ω–∞">–î–∏–∞–Ω–∞</option>
            <option value="–î–ª—è –≤—Å–µ—Ö">–î–ª—è –≤—Å–µ—Ö</option>
        </select>

        <p>–ù–∞–≥—Ä–∞–¥–∞:</p>
        <select id="reward-type" onchange="toggleRewardInputs()">
            <option value="–î–µ–Ω—å–≥–∏">üí∞ –î–µ–Ω—å–≥–∏</option>
            <option value="–î—Ä—É–≥–æ–µ">üéÅ –î—Ä—É–≥–æ–µ</option>
            <option value="–ë–µ–∑ –Ω–∞–≥—Ä–∞–¥—ã">üôå –ë–µ–∑ –Ω–∞–≥—Ä–∞–¥—ã</option>
        </select>
        <input type="number" id="reward-amount" step="0.01" placeholder="–°—É–º–º–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä 0.32)">
        <input type="text" id="reward-custom" class="hidden" placeholder="–û–ø–∏—à–∏—Ç–µ –Ω–∞–≥—Ä–∞–¥—É">

        <button onclick="saveTask()">–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ</button>
        <button class="alt" onclick="showScreen('main-screen')">–ù–∞–∑–∞–¥</button>
    </div>
</div>

<script>
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Supabase
    const SB_URL = "https://cvhweveaihbvtwixjzki.supabase.co";
    const SB_KEY = "sb_publishable_b5-XjyoKgERPDPOtS5wzOg_n2n-JKs0";
    const supabaseClient = supabase.createClient(SB_URL, SB_KEY);

    let currentUser = "";
    let userBalance = 0;

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(id === 'main-screen') {
            loadTasks();
            fetchBalance();
        }
    }

    async function setUser(name) {
        currentUser = name;
        document.getElementById('current-user-name').innerText = name;
        showScreen('main-screen');
    }

    function toggleInput(selectId, inputId, triggerValue) {
        const val = document.getElementById(selectId).value;
        document.getElementById(inputId).classList.toggle('hidden', val !== triggerValue);
    }

    function toggleRewardInputs() {
        const type = document.getElementById('reward-type').value;
        document.getElementById('reward-amount').classList.toggle('hidden', type !== '–î–µ–Ω—å–≥–∏');
        document.getElementById('reward-custom').classList.toggle('hidden', type !== '–î—Ä—É–≥–æ–µ');
    }

    async function fetchBalance() {
        const { data, error } = await supabaseClient.from('users').select('balance').eq('name', currentUser).single();
        if (data) {
            userBalance = data.balance;
            document.getElementById('user-balance').innerText = userBalance.toFixed(2);
        }
    }

    async function saveTask() {
        const taskType = document.getElementById('task-type').value;
        const taskName = taskType === '–î—Ä—É–≥–æ–µ' ? document.getElementById('custom-task').value : taskType;
        const taskFor = document.getElementById('task-for').value;
        const rewardType = document.getElementById('reward-type').value;
        
        let rewardValue = "";
        let amount = 0;

        if(rewardType === '–î–µ–Ω—å–≥–∏') {
            amount = parseFloat(document.getElementById('reward-amount').value) || 0;
            rewardValue = amount + "$";
        } else if(rewardType === '–î—Ä—É–≥–æ–µ') {
            rewardValue = document.getElementById('reward-custom').value;
        } else {
            rewardValue = "–ë–µ–∑ –Ω–∞–≥—Ä–∞–¥—ã";
        }

        const { error } = await supabaseClient.from('tasks').insert([{
            title: taskName,
            assignee: taskFor,
            reward_type: rewardType,
            reward_value: rewardValue,
            money_amount: amount,
            status: 'pending',
            created_by: currentUser
        }]);

        if (error) alert("–û—à–∏–±–∫–∞: " + error.message);
        else showScreen('main-screen');
    }

    async function loadTasks() {
        const container = document.getElementById('tasks-list');
        container.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞...";

        const { data, error } = await supabaseClient.from('tasks').select('*').order('created_at', { ascending: false });

        if (error) return container.innerHTML = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏.";

        container.innerHTML = "";
        data.forEach(task => {
            const card = document.createElement('div');
            card.className = 'task-card';
            
            let buttons = "";
            if(task.status === 'pending' && (task.assignee === currentUser || task.assignee === '–î–ª—è –≤—Å–µ—Ö') && currentUser !== '–ú–∞–º–∞') {
                buttons = `<button class="small" onclick="updateStatus('${task.id}', 'waiting_approval')">–í—ã–ø–æ–ª–Ω–∏–ª –∑–∞–¥–∞–Ω–∏–µ</button>`;
            } 
            else if(task.status === 'waiting_approval' && currentUser === '–ú–∞–º–∞') {
                buttons = `
                    <button class="small" onclick="approveTask('${task.id}', true)">–î–∞ (–í—ã–ø–ª–∞—Ç–∏—Ç—å)</button>
                    <button class="small alt" onclick="approveTask('${task.id}', false)">–ù–µ—Ç</button>
                `;
            }

            card.innerHTML = `
                <span class="status-badge">${translateStatus(task.status)}</span>
                <div style="margin-top:10px;"><strong>${task.title}</strong></div>
                <div style="font-size:13px; color:#666; margin: 5px 0;">–î–ª—è: ${task.assignee} | –ù–∞–≥—Ä–∞–¥–∞: ${task.reward_value}</div>
                ${buttons}
            `;
            container.appendChild(card);
        });
    }

    function translateStatus(s) {
        const map = { 'pending': '–û–∂–∏–¥–∞–µ—Ç', 'waiting_approval': '–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ', 'completed': '–ó–∞–≤–µ—Ä—à–µ–Ω–æ' };
        return map[s] || s;
    }

    async function updateStatus(id, newStatus) {
        await supabaseClient.from('tasks').update({ status: newStatus }).eq('id', id);
        loadTasks();
    }

    async function approveTask(id, isOk) {
        if (isOk) {
            const { data: task } = await supabaseClient.from('tasks').select('*').eq('id', id).single();
            
            if (task.reward_type === '–î–µ–Ω—å–≥–∏' && task.money_amount > 0) {
                const { data: userData } = await supabaseClient.from('users').select('balance').eq('name', task.assignee).single();
                if(userData) {
                    const newBalance = (userData.balance || 0) + task.money_amount;
                    await supabaseClient.from('users').update({ balance: newBalance }).eq('name', task.assignee);
                }
            }
            await updateStatus(id, 'completed');
            alert("–ó–∞–¥–∞–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ!");
        } else {
            await updateStatus(id, 'pending');
            alert("–ó–∞–¥–∞–Ω–∏–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ.");
        }
        fetchBalance();
    }

    async function withdrawMoney() {
        if (userBalance <= 0) return alert("–£ –≤–∞—Å 0 –Ω–∞ —Å—á–µ—Ç—É.");
        
        const amount = prompt("–°–∫–æ–ª—å–∫–æ –≤—ã–≤–µ—Å—Ç–∏?", userBalance);
        const numAmount = parseFloat(amount);

        if (numAmount > 0 && numAmount <= userBalance) {
            const { error } = await supabaseClient.from('users').update({ balance: userBalance - numAmount }).eq('name', currentUser);
            if (!error) {
                alert("–ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ú–∞–º–µ. –ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª–µ–Ω.");
                fetchBalance();
            }
        } else {
            alert("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—É–º–º–∞.");
        }
    }
</script>

</body>
</html>
